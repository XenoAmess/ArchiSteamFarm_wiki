# Двухфакторная аутентификация

Некоторое время назад Valve представило систему известную как "Удержание обменов", которая требует наличие дополнительного аутентификатора для различных действий связанных с аккаунтом. Вы можете прочесть об этом подробнее **[тут](https://support.steampowered.com/kb_article.php?ref=1284-WTKB-4729)** и **[тут](https://support.steampowered.com/kb_article.php?ref=8078-TPHC-6195)**. Важно понимать как работает двухфакторная аутентификация (далее - 2ФА), прежде чем пытаться понять работу 2ФА ASF.

Сейчас вы можете заметить, что все обмены удерживаются 15 дней, что не самая серьёзная проблемой при использовании ASF, но всё же достаточно неприятно, особенно для тех кому хотелось бы полной автоматизации. К счастью, ASF включает в себя решение этой проблемы, под названием 2ФА ASF.

* * *

# Логика работы ASF

Не зависимо от того, пользуетесь вы описанной ниже 2ФА ASF или нет, в ASF предусмотрена правильная логика работы, и полностью учитываются особенности работы с аккаунтами, защищёнными обычной 2ФА. У вас будут запрашивать необходимые данные когда они нужны (как например при входе). Если вы пользуетесь 2ФА ASF, программа сможет избежать этих запросов и автоматически генерировать нужные коды, избавив вас от беспокойства и позволив пользоваться дополнительными возможностями (описанными ниже).

* * *

# 2ФА ASF

Идея очень проста. У нас уже реализован клиент Steam, и реализован запуск игр, так почему не реализовать имитацию мобильного устройства? 2ФА ASF это именно то что вы думаете, это попросту модуль, способный генерировать коды 2ФА так же, как приложение Steam на мобильном устройстве, что позволяет избежать удержаний обменов и автоматически подтверждать все обмены. Он дублирует ваш существующий аутентификатор, поэтому нет необходимость пользоваться исключительно 2ФА ASF.

Чтобы включить 2ФА ASF, вам необходимы:

- Работающий аутентификатор Steam на устройстве с Android
- или работающий аутентификатор Steam на устройстве с iOS
- или работающий аутентификатор Steam в программе **[SteamDesktopAuthenticator](https://github.com/Jessecar96/SteamDesktopAuthenticator)**
- или работающий аутентификатор Steam в программе **[WinAuth](https://winauth.github.io/winauth)**

* * *

## Импорт

Начиная с версии V2.1 и выше, ASF не позволяет вам использовать 2ФА ASF в "соло" режиме - это значит что вам нужен уже работающий аутентификатор, поддерживаемый ASF. ASF на данный момент поддерживает четыре разных источника 2ФА - Android, iOS, SteamDesktopAuthenticator и WinAuth. Если у вас ещё нет аутентификатора, и вы собираетесь подключать его впервые, я настоятельно рекомендую пользоваться WinAuth, из которого затем можно будет импортировать в ASF (и пользоваться им самим).

Все последующие руководства требуют чтобы у вас уже был **настроенный и работающий** аутентификатор в одном из заданных приложений. 2ФА ASF не будет работать если вы импортируете неверные данные, поэтому убедитесь что аутентификатор правильно работает перед тем как его импортировать. Это включает в себя тестирование и проверку того, что следующие функции аутентифиатора работают правильно:

- Вы можете генерировать коды для входа и эти коды принимаются сетью Steam
- Вы можете получить список операций, требующих подтверждения, и они отображаются в вашем мобильном аутентификаторе
- Вы можете подтверждать эти операции, и они правильно отображаются сетью Steam как подтверждённые/отклонённые

Убедитесь что ваш аутентификатор работает проверив, работают ли функции описанные выше - если нет, то они не будут работать и в ASF, и вы просто зря потратите время.

* * *

### Android-смартфон

В общем случае для импорта аутентификатора со смартфона под Android вам потребуется **[root](https://ru.wikipedia.org/wiki/%D0%A0%D1%83%D1%82%D0%B8%D0%BD%D0%B3)**-доступ. В **[SDA](https://github.com/Jessecar96/SteamDesktopAuthenticator/blob/master/README.md)** ранее был **[способ](https://github.com/Jessecar96/SteamDesktopAuthenticator/wiki/Importing-account-from-an-Android-phone)** без root, но он больше не работает и теперь невозможно получить защищенные файлы Steam без root-прав. Единственный возможный на данный момент способ без root-доступа это создание резервной копии раздела `/data` тем или иным способом и получение необходимых файлов из этой копии вручную на вашем ПК. Поскольку эта возможность сильно зависит от ОС и не является стандартной для Android, мы не будем её здесь рассматривать. Если вам повезло иметь такую возможность, вы можете ей воспользоваться, но у большинства пользователей ничего подобного не будет.

Рутинг отличается на разных устройствах, поэтому мы не можем сказать вам как получить root на вашем устройстве. Посетите **[форум 4PDA](https://4pda.ru/forum/)** и найдите руководство для вашего устройства. Если вы не смогли найти там руководство для вашего устройства, попробуйте поискать в google.

В процессе импорта нам нужно получить доступ к защищённым файлам. Поэтому вам понадобиться скачать любой root-проводник доступный в Play Маркет, такой как **[этот](https://play.google.com/store/apps/details?id=com.jrummy.root.browserfree)** (или любой другой на самом деле). Вы также можете воспользоваться ADB (Android Debug Bridge) или любой другой доступный вам способ доступа и копирования защищённых файлов на ваш ПК.

Теперь вы можете выбрать, хотите ли вы импортировать ваш аутентификатор сначала в WinAuth, а затем в ASF, или в ASF напрямую. Первый вариант проще и позволит вам продублировать аутентификатор также на вашем ПК, позволив вам подтверждать операции и создавать коды в 3 разных местах - на телефоне, на ПК и через ASF. Если вы хотите этого, просто откройте WinAuth, добавьте новый аутентификатор Steam и выберите пункт импорта из Android, затем следуйте инструкциям. После окончания, вы можете импортировать аутентификатор из WinAuth в ASF, как описано ниже.

Если вы не хотите, или вам не нужно использовать WinAuth, то просто скопируйте `/data/data/com.valvesoftware.android.steam.community/files/Steamguard-XXX` где XXX - ваш `SteamID` от аккаунта, который вы хотите добавить (если их больше одного, поскольку если у вас только один аккаунт, то там будет только один файл). Помните что папкаа `/data/data` является защищённой и вы не сможете получить к ней доступ без root-прав. Как только этот файл будет на вашем ПК, переименуйте его в `BotName.maFile` (где `BotName` - имя бота для которого вы хотите добавить 2ФА ASF) и скопируйте в папку `config` вашего ASF. После этого шага запустите ASF - он должен обнаружить файл с расширением `.maFile` и импортировать его.

    [*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
    <1> Пожалуйста, введите Device ID вашего мобильного аутентификатора (включая "android:"):
    

Вам нужно выполнить ещё один шаг - найти параметр `DeviceID` в файле `/data/data/com.valvesoftware.android.steam.community/shared_prefs/steam.uuid.xml`. Он будет заключен в теги XML и будет начинаться с `android:`. Скопируйте его и вставьте по запросу ASF. Если всё сделано правильно, импорт должен быть завершен.

    [*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
    

Убедитесь что подтверждение операций действительно работает. Если вы ошиблись на этапе ввода вашего `DeviceID` ваш аутентификатор будет работать только наполовину - коды для входа будут работать, но подтверждение операций нет. Вы всегда можете при необходимости удалить файл `Bot.db` и начать всё заново.

* * *

### iOS

Для iOS вам понадобится **[ios-steamguard-extractor](https://github.com/CaitSith2/ios-steamguard-extractor)**. Это возможно благодаря тому, что вы можете сделать нешифрованную резервную копию, скопировать её на ПК и использовать эту утилиту чтобы извлечь данные Steam, которые нельзя получить иным образом (во всяком случае без jailbreak, из-за шифрования iOS).

Перейдите к **[последней версии](https://github.com/CaitSith2/ios-steamguard-extractor/releases/latest)** и скачайте программу. После того, как вы извлекли нужные данные, вы можете например импортировать их в WinAuth, а затем из WinAuth в ASF (хотя вы можете просто скопировать json-часть начиная с `{` и заканчивая `}` в файл `BotName.maFile` и продолжать как обычно). Если вы спросите меня - я настоятельно рекомендую сначала импортировать в WinAuth и убедиться что и создание кодов и подтверждение операций работают правильно, чтобы знать всё ли хорошо. Если ваши учетные данные неверные, 2ФА ASF будет работать неправильно, поэтому лучше делать импорт в ASF в последнюю очередь.

Для вопросов и сообщения о проблемах перейдите в раздел **[issues](https://github.com/CaitSith2/ios-steamguard-extractor/issues)**.

*Помните, что эта утилита неофициальная, и вы пользуетесь ею на свой страх и риск. Мы не предоставляем технической поддержки если это не работает - нам несколько раз сообщали что могут быть экспортированы неверные данные 2ФА - поэтому проверьте что в правильно работает подтверждение операций в чём-то типа WinAuth прежде чем импортировать данные в ASF!*

* * *

### SteamDesktopAuthenticator

Если у вас уже есть аутентифицатор, работающий в SDA, вы можете заметить что у вас уже есть файл `steamID.maFile` в папке `maFiles`. Скопируйте этот файл в папку `config` вашего ASF. Убедитесь, что этот `.maFile` в незашифрованном виде, поскольку ASF не умеет расшифровывать файлы SDA - незашифрованный файл должен начинаться с символа `{`.

Теперь вам надо переименовать файл из `steamID.maFile` в `BotName.maFile` в вашей папке `config`, где `BotName` - имя бота для которого вы хотите добавить 2ФА ASF. Вы можете оставить всё как есть, ASF обнаружит этот файл автоматически после входа в Steam. Если вы поможете ASF, переименовав файл, ASF сможет использовать 2ФА ASF ещё до входа, а если нет - файл будет импортирован только после того как ASF успешно войдёт (поскольку ASF не знает `steamID` вашего аккаунта до того как войдёт).

Если вы всё сделали правильно, запустите ASF, вы должны увидеть:

    [*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
    [*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
    

С этого момента ваш 2ФА ASF должен быть работоспособен на этом аккаунте.

* * *

### WinAuth

Сначала создайте новый пустой файл `BotName.maFile` в папке `config` вашего ASF, где `BotName` это имя вашего бота, для которого вы хотите добавить 2ФА ASF. Помните, что имя должно быть `BotName.maFile` а НЕ `BotName.maFile.txt`, Windows по-умолчанию скрывает расширения для зарегистрированных типов файлов. Если имя файла будет неверным, ASF не обнаружит его.

Теперь запустите WinAuth как обычно. Кликните правой кнопкой мыши на иконке Steam и выберите "Show SteamGuard and Recovery Code". Поставьте отметку в поле "Allow copy". Вы должны увидеть уже знакомую вам JSON-структуру в нижней части окна, начинающуюся с `{`. Скопируйте весь текст в файл `BotName.maFile`, созданный на предыдущем этапе.

Если вы всё сделали правильно, запустите ASF, вы должны увидеть:

    [*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
    <1> Пожалуйста, введите Device ID вашего мобильного аутентификатора (включая "android:"):
    

Теперь начинается более сложная часть. В WinAuth отсутствует параметр deviceID, который необходим ASF, поэтому вам надо сделать ещё одну вещь.

Вернитесь к окну "Show SteamGuard and Recovery Code" в WinAuth, там вы должны заметить поле "Device ID" выше кода JSON который вы только что копировали. Скопируйте полностью содержимое этого поля, включая часть `android:`, и вставьте по запросу ASF.

Если вы сделали всё правильно, то теперь всё готово!

    [*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
    

Проверьте пожалуйста, что подтверждение операций действительно работает. Если вы ошиблись на этапе ввода вашего `DeviceID` ваш аутентификатор будет работать только наполовину - коды для входа будут работать, но подтверждение операций нет. Вы всегда можете при необходимости удалить файл `Bot.db` и начать всё заново.

* * *

С этого момента все команды `2fa` будут работать как будто на вашем обычном устройстве 2ФА. Вы можете использовать одновременно 2ФА ASF и ваш аутентификатор (Android, iOS, SDA или WinAuth) для генерации кодов и подтверждения операций.

Если у вас есть аутентификатор на телефоне, вы можете по желанию удалить SteamDesktopAuthenticator и/или WinAuth, поскольку он вам больше не понадобится. Однако я советую оставить его просто на всякий случай, даже не говоря о том что пользоваться им гораздо удобнее чем обычным аутентификатором Steam. Не забывайте, что 2ФА ASF это **НЕ** замена обычному аутентификатору, и **никогда** не должна использоваться как единственный аутентификатор, поскольку в 2ФА ASF хранятся не все данные, которые должен иметь полноценный аутентификатор. Невозможно конвертировать 2ФА ASF назад в обычный аутентификатор, поэтому всегда имейте основной аутентификатор в другом месте, как например в WinAuth/SDA или на телефоне.

* * *

## ЧаВО

### Как ASF использует модуль 2ФА?

Если 2ФА ASF настроена, ASF будет автоматически подтверждать все обмены которые отправляет/получает ASF. Также будет возможно автоматически при необходимости создавать коды 2FA, например чтобы выполнить вход. В добавок к этому, наличие 2ФА ASF делает доступными команды `2fa` для вашего удобства. Это должно быть всё, если я ничего не забыл - проще говоря, ASF использует модуль 2ФА по мере необходимости.

* * *

### Что если мне нужен код 2ФА?

Вам нужен код 2ФА для любого аккаунта, защищённого 2ФА, это также включает в себя каждый аккаунт с 2ФА ASF. Вам стоит создавать коды в аутентификаторе, который вы использовали для импорта, но вы можете также создавать временные коды с помощью команды `2fa`, отправив её через чат выбранному боту. Вы также можете использовать команду `2fa <BotNames>` чтобы сгенерировать временные коды для указанных ботов. Этого должно быть достаточно чтобы получить доступ к ботам через, например, браузер, но как я отметил выше - вам стоит использовать вместо этого более удобный аутентификатор (Android, iOS, SDA или WinAuth).

* * *

### Могу ли я пользоваться своим обычным аутентификатором после импорта в 2ФА ASF?

Да, ваш аутентификатор останется полностью работоспособным и вы можете использовать его одновременно с 2ФА ASF. В этом смысл всего процесса - мы импортируем данные вашего аутентификатора в ASF, чтобы ASF мог использовать их и подтверждать операции обмена, нужные вам.

* * *

### Где в ASF хранится мобильный аутентификатор?

Мобильный аутентификатор в ASF хранится в файле `BotName.db`, в вашей папке `config`, вместе с другой важной информацией относящейся к аккаунту. Если вы хотите удалить 2ФА ASF, читайте инструкцию ниже.

* * *

### Как удалить ASF 2FA?

Просто остановите ASF и удалите файл `BotName.db` соответствующий боту 2ФА ASF которого вы хотите удалить. Это удалит импортированный 2ФА, привязанный к ASF, но НЕ отвяжет аутентификатор от аккаунта. Если вместо этого вы хотите отвязать свой аутентификатор, то кроме удаления его из ASF (сначала), вам нужно отключить его в том аутентификаторе, которым вы пользуетесь (Android, iOS, SDA или WinAuth), или - если по какой-то причине вы не можете, использовать код восстановления, который вы получили при подключении аутентификатора, на сайте Steam.

* * *

### Я подключил аутентификатор через SDA/WinAuth, а затем импортировал его в ASF. Можно мне теперь отключить его и заново подключить к своему телефону?

**Нет**. ASF **импортирует** данные вашего аутентификатора чтобы им пользоваться. Если вы отключите аутентификатор, то 2ФА ASF перестанет работать, не зависимо от того, удалили вы его как сказано выше, или нет. Если вы хотите использовать аутентификатор одновременно на телефоне и в ASF (плюс возможно в SDA/WinAuth), то вам нужно **импортировать** аутентификатор с вашего телефона, а не создавать новый в SDA/WinAuth. У вас может быть подключен только **один** аутентификатор, поэтому ASF **импортирует** этот аутентификатор со всеми данными для использования в 2ФА ASF - это **тот же самый** аутентификатор, просто существующий в двух местах. Если вы решите отключить ваш мобильный аутентификатор - не важно каким способом - 2ФА ASF перестанет работать, поскольку скопированный ранее аутентификатор будет уже неверным. Чтобы использовать 2ФА ASF вместе с аутентификатором на телефоне, вы должны импортировать его с Android/iOS, как описано выше.

* * *

### Лучше ли использовать для подтверждения всех операций 2ФА ASF по сравнению с WinAuth/SDA/Другим аутентификатором?

**Да**, по ряду причин. Первое, и самое главное - использование 2ФА ASF **значительно** увеличивает безопасность, поскольку модуль 2ФА в ASF будет следить чтобы ASF подтверждал автоматически только собственные обмены, так что даже если атакующий попытается запросить обмен, который вреден для вас, 2ФА ASF **не** примет такой обмен, поскольку он не был создан с помощью ASF. В добавок к безопасности, использование 2ФА ASF также даёт преимущества в производительности и оптимальности, поскольку 2ФА ASF подтверждает обмены сразу после того как они созданы, и только тогда, в противоположность поиску неподтвержденных операций каждые X минут как сделано например в SDA или WinAuth. Короче говоря, нет причин использовать сторонний аутентификатор если вы хотите автоматически подтверждать обмены, созданные ASF - именно для этого создана 2ФА ASF, и её использование никак не мешает вам подтверждать всё остальное в своём любимом аутентификаторе. Мы настоятельно рекомендуем использовать 2ФА ASF для всех действий ASF - это гораздо безопаснее чем прочие решения.

* * *

## Дополнительно

Если вы продвинутый пользователь, вы можете также создать maFile вручную. Он должен иметь **[корректную JSON структуру](https://jsonlint.com)**, состоящую из:

```json
{
  "shared_secret": "STRING",
  "identity_secret": "STRING",
  "device_id": "STRING"
}
```

`device_id` является необязательным при импорте, но обязательным для работы ASF - ASF запросит этот параметр отдельно, если он не указан. Разумеется, вам нужно заменить `"STRING"` на правильные данные для каждого параметра.

В стандартных аутентификаторах имеется больше параметров - они полностью игнорируются ASF в процессе импорта, поскольку нам они не нужны. Вам также не нужно их удалять - ASF требуется только корректная структура JSON С 2 обязательными полями, указанными выше, и опционально с `device_id`.