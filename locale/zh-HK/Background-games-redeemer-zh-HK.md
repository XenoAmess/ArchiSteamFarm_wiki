# 後臺遊戲兌換機

後臺遊戲兌換機是一個特殊的 ASF 內置功能, 允許您導入給定的 Steam CD 金鑰集 (及其名稱) 以在後臺兌換。 如果您想批次激活多組產品序號，請確保觸發`RateLimited` **[status](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/FAQ#what-is-the-meaning-of-status-when-redeeming-a-key)** 才能完成整個過程。

背景序號啟動器僅對單個機器人有效，也就是說它不會採用 `RedeemingPreferences` 的設置。 如有需要，此功能可以與 `redeem` **[command](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Commands)** 一起使用（或代替）。

* * *

## 匯入

匯入可以通過兩種方式進行，使用文字檔案或 IPC。

### 檔案：

ASF 會識別`config` 資料夾下名為 `BotName.keys` 的檔案，其中 `BotName` 是您的機器人名稱。 該檔案必須按固定格式編寫，每行由遊戲名稱和遊戲序號組成，兩者之間須以 Tab 分隔，並以一個分行符號結束，表示開始下一項。 如果使用多個 Tab，則第一項條目會被視為是遊戲名稱，最後一項會被視為是遊戲序號，中間的所有內容都將被忽略。 範例：

    POSTAL 2	ABCDE-EFGHJ-IJKLM
    Domino Craft VR	12345-67890-ZXCVB
    A Week of Circus Terror	POIUY-KJHGD-QWERT
    Terraria	忽略	忽略	ZXCVB-ASDFG-QWERT
    

或者, 您還可以只使用遊戲序號格式 (每個條目之間仍須有一個分行符號)。 在這種情況下，如有可能，ASF 將會向 Steam 詢問正確的遊戲名稱。 對於任何類型的金鑰標記，我們建議您使用自訂名稱，因為在 Steam 上兌換的包名稱不一定會符合包中的遊戲名稱，所以根據開發者填寫的內容，您可能會看到正確的遊戲名稱、自訂包名稱（例如 Humble Indie Bundle 18），或完全錯誤、甚至是惡意的名稱（例如 Half-Life 4）。

    ABCDE-EFGHJ-IJKLM
    12345-67890-ZXCVB
    POIUY-KJHGD-QWERT
    ZXCVB-ASDFG-QWERT
    

無論你決定使用哪種格式，ASF 都將在機器人啟動或執行時匯入你的 `keys` 檔案。 成功分析檔並跳過無效序號後, 所有正確檢測到的遊戲都將添加到後臺佇列中, `BotName.keys` 檔本身將自動從 `config` 目錄中刪除。

### IPC

除了使用上面提到的產品序號檔外, ASF還公開了 `GamesToRedeemInBackground` < 1>ASF api endpointt\ 1 >, 它可以由任何IPC 工具 (包括我們的 ASF-ui) 執行。 IPC 將可提供更完善的功能，因為你可以使用你覺得合適的方式進行解析。例如使用自訂分隔符號，而非強制使用 Tab，甚至可以完全自訂序號格式。

* * *

## 佇列

成功導入遊戲後, 它們將添加到佇列中。 只要機器人與 Steam 網路保持連線，且佇列中仍有遊戲，ASF 就會自動處理背景佇列。 嘗試啟動序號且沒有觸發 `RateLimited` 後，該序號將會被移出佇列並根據其啟動結果寫入位於 `config` 資料夾中的檔案。當序號被使用時（例如結果為：`NoDetail`、`BadActivationCode`、`DuplicateActivationCode`），將會寫入 `BotName.keys.used`，否則就會寫入 `BotName.keys.unused`。 由於 Steam 網路不一定會回傳序號所屬遊戲的正確名稱，所以 ASF 會使用你提供的遊戲名稱。這樣你就可以根據需要使用自訂名稱標記你的序號。

如果在啟動過程中帳戶觸發 `RateLimited` 狀態，佇列將會暫停一小時以等待冷卻時間結束。 之後，啟動程序將會從中斷的地方繼續，直到佇列完全清空。

* * *

## 範例

假設你有一個包含 100 個序號的清單。 首先, 您應該在ASF `config` 目錄中創建一個新的 `BotName.keys.new` 檔。 我們加上 `.new` 後綴是為了防止 ASF 在建立檔案時立刻讀取該檔案（因為它是一個全新的檔，尚未準備匯入）。

現在您可以打開我們剛建立的檔案，貼上100 個序號，並視情況修正格式。 修復後， `BotName.keys.new` 檔案中應該正好有 100 行（如果末尾有換行符的話就是 101 行），每一行的格式均為 `遊戲名稱\t遊戲序號\n`，其中 `\t` 是 Tab 符，`\n` 是換行符。

現在您已可將該檔案從 `BotName.keys.new` 重新命名為 `BotName.keys`，以便讓 ASF 知道該檔案已準備好匯入。 重新命名後，ASF 會自動匯入該檔案（不需要重啟），並在確認所有遊戲皆解析成功且加入佇列後刪除該檔案。

除了 `BotName.keys` 檔案，您也可以使用 IPC API 端點，甚至也可以根據需要將兩種方式合併使用。

一段時間後，可能會生成 `BotName.keys.used` 和 `BotName.keys.unused` 等檔案。 這些檔案包含了我們兌換過程的結果。 例如, 您可以將 `BotName.keys.unused` 重命名為 `BotName2.keys` 檔, 以便為其他機器人提交我們未使用的金鑰, 因為前一個機器人並未使用這些金鑰。 或者, 您可以簡單地將未使用的金鑰複製粘貼到其他檔中, 並將其保留以待調用。 請謹記，當 ASF 處理佇列時，新的條目將被添加入 `used` 和 `unused` 等檔，因此建議等待佇列完全清空後再使用這些檔。 如果在佇列完全清空之前需要訪問這些檔, 則應首先將欲訪問的檔 **移動** 其他目錄的輸出檔案, **之後** 對其進行處理。 這是因為 ASF 可能會在你處理這些檔案的時候寫入新的結果，且可能導致某些金鑰遺失。例如，你讀取了一個包含 3 個序號的檔案，然後將其刪除，但 ASF 在此期間又寫入了 4 個新序號，這可能會導致那些金鑰遺失。 如果要訪問這些檔, 請確保在讀取這些檔之前將它們移出 asf `config` 目錄, 例如通過重命名。

您還可以通過重複上述所有步驟, 在佇列中已有一些遊戲的情況下, 添加額外的遊戲。 ASF 會正確地將我們的額外條目加入正在進行的佇列中並處理之。

* * *

## 備註

後臺序號啟動器在底層使用了 `OrderedDictionary`，這意味着您的遊戲金鑰將會按照檔案中指定（或 IPC API 調用）的順序啟動。 這意味著如果某些金鑰需要先擁有另一個序號才能啟動，請您將其列於該金鑰後方。 例如，這意味著如果您有 DLC `D` ，且需要先啟動遊戲 `G` 才能啟動，那麼您**應**將遊戲 `G` 的金鑰排在 DLC `D` 的金鑰前面。 同樣，如果 DLC `D`依賴于`A`、`B` 和 `C`，那麼這三個金鑰就應該放在D前面（任意順序均可，除非它們有自己的依賴關係）。

如果不遵循上述方案, 即使您的帳戶在流覽其整個佇列後有資格啟動DLC, 也會因`DoesNotOwnRequiredApp` 而無法啟動。 若想避免這種情況, 請確保你的 dlc 總是列在你的佇列中的基本遊戲之後。